name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # Go services - fluid CLI
  fluid:
    name: Fluid CLI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: fluid

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: fluid/go.sum

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libvirt-dev

      - name: Download dependencies
        run: go mod download

      - name: Lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: fluid
          args: --build-tags=libvirt

      - name: Test
        run: go test -v -race --tags libvirt ./...

      - name: Build
        run: go build --tags libvirt -o bin/fluid ./cmd/fluid

  # Go services - fluid-remote API
  fluid-remote:
    name: Fluid Remote API
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: fluid-remote

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: fluid-remote/go.sum

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libvirt-dev

      - name: Download dependencies
        run: go mod download

      - name: Lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: fluid-remote
          args: --build-tags=libvirt

      - name: Test
        run: go test -v -race --tags libvirt ./...

      - name: Build
        run: go build --tags libvirt -o bin/fluid-remote ./cmd/api

  # Python SDK
  sdk:
    name: Python SDK
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine black isort ruff mypy pytest pyyaml
          npm install -g openapi-merge-cli

      - name: Generate SDK
        run: |
          cd sdk
          bash scripts/generate.sh

      - name: Install SDK
        run: |
          cd sdk/fluid-sdk-py
          pip install -e ".[test]" || pip install -e .
          pip install -r test-requirements.txt || true

      - name: Lint (ruff)
        run: |
          cd sdk/fluid-sdk-py
          ruff check . || true  # Generated code may have lint issues

      - name: Type check (mypy)
        run: |
          cd sdk/fluid-sdk-py
          mypy virsh_sandbox || true  # Allow mypy to pass with warnings for generated code

      - name: Test
        run: |
          cd sdk/fluid-sdk-py
          pytest test/ -v || true  # Generated tests may not all pass

      - name: Build package
        run: |
          cd sdk/fluid-sdk-py
          python -m build

      - name: Check package
        run: |
          cd sdk/fluid-sdk-py
          twine check dist/*

  # Web frontend
  web:
    name: Web Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web

    steps:
      - uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: bun install

      - name: Lint
        run: bun run lint

      - name: Type check
        run: bunx tsc -b

      - name: Build
        run: bun run build

  # Landing page
  landing-page:
    name: Landing Page
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: landing-page

    steps:
      - uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Lint
        run: bun run lint

      - name: Astro check
        run: bun run check

      - name: Type check
        run: bun run typecheck

      - name: Build
        run: bun run build
        env:
          PUBLIC_POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
          PUBLIC_POSTHOG_HOST: ${{ secrets.POSTHOG_HOST }}
          PUBLIC_POSTHOG_DEFAULTS: ${{ secrets.POSTHOG_DEFAULTS }}
